<!DOCTYPE html>
<html>
  <head>
    <title>For the Moon is Hollow and I Have Touched the Sky</title>

    <meta http-equiv="Pragma" content="no-cache, no-store" />
    <meta http-equiv="Expires" content="31 Dec 1997" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>

    <!-- 
         Wanderer moon
         smiling a
         faintly ironical smile
         at this
         brilliant, dew-moistened
         summer morning,
         a detached
         sleepily indifferent
         smile, a
         wanderer's smile,
         if I should
         buy a shirt
         your color and
         put on a necktie
         sky-blue
         where would they carry me?

         - 1917, william carlos williams
      -->
    
    <script src="createjs.min.js"></script>
    <script type="text/javascript">

      const cjs = createjs;
      
      (function () {

	  const viewPortSize = { w:650, h:290 };
	  
	  var KEYS = {arrowup:false, arrowdown:false, arrowleft:false, arrowright:false, spacebar:false};
	  var soundInstance;

	  var PAUSED = false;
          var DEAD_CENTER;
          var INDEX = 0;
          var ARR = [];
	  

	  //--------------------------------------------------------------------------------- initKeys
	  function initKeys(){
	      
              let codes = {38: "arrowup", "ArrowUp": "arrowup",
			   40: "arrowdown", "ArrowDown": "arrowdown",
			   37: "arrowleft", "ArrowLeft": "arrowleft",
			   39: "arrowright", "ArrowRight": "arrowright",
			   32: "spacebar", " ": "spacebar" };
	      
              document.onkeydown = (e) => {
		  if(e.repeat){return;};
		  let c = event.key || event.keyCode;
		  let k = codes[c];
		  if(KEYS.hasOwnProperty(k)){ KEYS[k] = true; };

		  if(k == "spacebar"){ togglePause(); };
              };
	      
              document.onkeyup = (e) => {
		  if(e.repeat){return;};
		  let c = event.key || event.keyCode;
		  let k = codes[c];

		  if(KEYS.hasOwnProperty(k)){ KEYS[k] = false; };
              };
	  }

	  
	  //------------------------------------------------------------------------------- togglePause
	  function togglePause(){

	      PAUSED = !PAUSED;
	      soundInstance.paused = !soundInstance.paused;
	  }


          //------------------------------------------------------------------------ buildDashboard
          function buildDashboard(DEAD_CENTER, viewPortSize){

	      let dash = new cjs.Container();
	      
	      let vpX = (0 - (viewPortSize.w/2));
	      let vpY = (0 - (viewPortSize.h/2));
	      let vpW = viewPortSize.w;
	      let vpH = viewPortSize.h;       
	      
	      let viewportFrame = new cjs.Shape();
	      viewportFrame.graphics.s("#ffffff").dr(vpX,vpY,vpW,vpH);
	      viewportFrame.x = DEAD_CENTER.x;
	      viewportFrame.y = DEAD_CENTER.y;        
	      viewportFrame.alpha = 0.4;
	      viewportFrame.cache(vpX,vpY,vpW,vpH);
	      
	      let crash = new cjs.Shape();
	      crash.graphics.f("#ff0000").dr(vpX,vpY,vpW,vpH);
	      crash.x = DEAD_CENTER.x;
	      crash.y = DEAD_CENTER.y;        
	      crash.alpha = 0.3;
	      crash.visible = false;
	      crash.cache(vpX,vpY,vpW,vpH);           
	      
	      let pass = new cjs.Shape();
	      pass.graphics.f("#00cc00").dr(vpX,vpY,vpW,vpH);                
	      pass.x = DEAD_CENTER.x;
	      pass.y = DEAD_CENTER.y;        
	      pass.alpha = 0.3;
	      pass.visible = false;
	      pass.cache(vpX,vpY,vpW,vpH);            
	      
	      let sight = new cjs.Bitmap(queue.getResult("sight"));
	      sight.x = DEAD_CENTER.x - 60;
	      sight.y = DEAD_CENTER.y - 60;
	      sight.alpha = 0.9;
	      
	      dash.addChild(crash);
	      dash.addChild(pass);        
	      dash.addChild(viewportFrame);
	      dash.addChild(sight)    
	      
	      dash.crash = crash;
	      dash.pass = pass;
	      
	      return dash;
          }

                    
          //------------------------------------------------------------------------------ makeMoon
          let moonCount = 0;
          
          function makeMoon(){

	      let c = new cjs.Container();
	      c.x = DEAD_CENTER.x;
	      c.y = DEAD_CENTER.y;

	      c.mask = new cjs.Shape();
	      c.mask.graphics.f("#000000").dc(0,0,100);
	      
	      c.name = moonCount;
	      moonCount++;
	      c.visible = false;

	      c.moonScale = 0.25;
	      c.maskScale = 0.25;             
	      
	      c.rotation = Math.floor(Math.random() * 358) + 1
	      c.rotationDir = (Math.random() > .45) ? 1 : 0;
	      c.rotationAmt = random(1,3)/10;

	      let inner = new cjs.Container();
	      
	      let space = new cjs.Shape();
	      space.graphics.f("#000").dr(-3000,-3000,6000,6000);
	      inner.addChild(space);
	      
	      let bit = new cjs.Bitmap(queue.getResult("moonJPG"));
	      bit.x = bit.y = -1816;
	      inner.addChild(bit);

	      for(var i = 0; i < 10; i++){
                  let x = new cjs.Bitmap(queue.getResult("shadow"));
                  x.scale = random(0,20)
                  x.regX = x.regY = random(-1000,1000)
                  x.rotation = Math.floor(Math.random() * 358) + 1;
                  x.alpha = Math.random();
                  inner.addChild(x);
	      }

	      let trackdot = new cjs.Shape();
	      trackdot.graphics.f("#ccc").dc(0,0,1);
	      trackdot.x = random(100,350);
	      c.trackdot = trackdot;
	      inner.addChild(trackdot);

	      let shade = new cjs.Shape();
	      shade.graphics.f("#000000").dc(0,0,2000);
	      shade.alpha = 0.2;
	      c.shade = shade;

	      inner.cache(-3000,-3000,6000,6000);             
	      c.addChild(inner);
	      c.addChild(shade);
	      
	      return c;
          }
	  
	  
	  //--------------------------------------------------------------------------------- init
	  function init(){
	      
              cjs.Ticker.framerate = 60;
              cjs.Ticker.timingMode = cjs.Ticker.RAF;
              
              let stage = new cjs.Stage("canvas1");
              cjs.Ticker.addEventListener('tick', stage);
              stage.x = stage.y = 0.5;

	      initKeys();
	      
              let soundProps = new cjs.PlayPropsConfig().set({loop: -1})
              soundInstance = cjs.Sound.play("sound", soundProps);

	      DEAD_CENTER = {
		  x:(stage.canvas.width/2),
		  y:(stage.canvas.height/2)
              };

              // currentMoon
              ARR.push(makeMoon())
              ARR[0].visible = true;
              ARR[0].mask = null;
              ARR[0].shade.alpha = 0;
              stage.addChild(ARR[0])
              
              // nextMoon
              ARR.push(makeMoon())
              ARR[1].visible = true;
              stage.addChild(ARR[1])


              let dash = buildDashboard(DEAD_CENTER, viewPortSize);          
              stage.addChild(dash);

	      var scaleDivisor = 120;
	      
	      
              //----------------------------------------------------------------------------- nextLevel
              function nextLevel(current, next, transPt){

		  let hit = !concentric(DEAD_CENTER,70,transPt,(100 * next.maskScale));

		  if(hit){

		      scaleDivisor -= 20;
		      if(scaleDivisor < 20){ gameOver(); return; };
		      
                      cjs.Tween.get(dash.crash)
			  .to({visible:true})                 
			  .wait(500)
			  .to({visible:false})
			  .wait(200)
			  .to({visible:true})
			  .wait(500)
			  .to({visible:false})
                      
                      next.mask.x = DEAD_CENTER.x;
                      next.mask.y = DEAD_CENTER.y;
		      
		  }else{
		      
                      dash.pass.visible = true;
                      cjs.Tween.get(dash.pass)
			  .to({visible:true})
			  .wait(300)
			  .to({visible:false})
		  };
		  
		  stage.removeChild(dash);
		  
		  cjs.Tween.get(next.mask).to({scale:6, x:DEAD_CENTER.x, y:DEAD_CENTER.y}, 1000).call(()=>{
                      stage.removeChild(current);
                      next.mask = null;
		  });

		  let m = makeMoon();
		  stage.addChild(m);
		  stage.addChild(dash);           

		  ARR.push(m);
		  INDEX++

		  for(var i=0; i < ARR.length; i++){ // remove old moons
                      if(i < (INDEX-1)){ ARR[i] = null; };
		  };
              }

	      
              //--------------------------------------------------------------------------------- tick
              cjs.Ticker.addEventListener('tick', function(){

		  if(PAUSED){ return; }
		  
		  let currentMoon = ARR[INDEX];
		  let nextMoon = ARR[INDEX + 1];
		  
		  if(KEYS.arrowdown) { currentMoon.y-= 2 + (currentMoon.moonScale / 2)};
		  if(KEYS.arrowup)   { currentMoon.y+= 2 + (currentMoon.moonScale / 2)};
		  if(KEYS.arrowleft) { currentMoon.x+= 2 + (currentMoon.moonScale / 2)};
		  if(KEYS.arrowright){ currentMoon.x-= 2 + (currentMoon.moonScale / 2)};
		  
		  let scaleAmt = ((currentMoon.moonScale / 2) / scaleDivisor)

		  nextMoon.visible = true;
		  
		  if(currentMoon.moonScale > 1){
                      nextMoon.shade.alpha -= 0.001;
                      currentMoon.shade.alpha += 0.002;
		  }

		  if(nextMoon.rotationDir == 1){
                      nextMoon.rotation += nextMoon.rotationAmt;
		  }else{
                      nextMoon.rotation -= nextMoon.rotationAmt;
		  };
		  
		  if(currentMoon.moonScale > 2.5){
                      nextMoon.moonScale += 0.001;
		  }
		  
		  if(currentMoon.moonScale < 3){
                      currentMoon.moonScale += scaleAmt;
                      nextMoon.maskScale += scaleAmt;
		  }

		  if(currentMoon.rotationDir == 1){
                      currentMoon.rotation += currentMoon.rotationAmt;
		  }else{
                      currentMoon.rotation -= currentMoon.rotationAmt;
		  };
		  
		  let transPt = currentMoon.localToGlobal(currentMoon.trackdot.x, currentMoon.trackdot.y);
		  nextMoon.mask.x = transPt.x;
		  nextMoon.mask.y = transPt.y;

		  currentMoon.scale = currentMoon.moonScale;
		  nextMoon.scale = nextMoon.moonScale;            
		  nextMoon.mask.scale = nextMoon.maskScale;
		  
		  if(currentMoon.moonScale > 3) {
                      nextLevel(currentMoon, nextMoon, transPt);
		  }       

              });

	      
              //------------------------------------------------------------------------------ gameOver
              function gameOver(){

		  stage.removeAllChildren();
		  cjs.Ticker.removeAllEventListeners();
		  alert('game over');
	      }
	      
	  }

	  
	  //--------------------------------------------------------------------------------- helpers
	  function random(min, max) {
              return Math.floor(Math.random() * (max - min + 1) + min);
	  }
	  
	  function getDistance(pt1, pt2){
              var distance = Math.sqrt(Math.pow((pt2.x - pt1.x),2) + Math.pow((pt2.y - pt1.y),2));
              return distance;
	  }
	  
	  function concentric(center1, radius1, center2, radius2){
              var d = getDistance(center1, center2);
              return ((d + radius1) < radius2);
	  }

	  
	  //--------------------------------------------------------------------------------- load
	  var queue = new createjs.LoadQueue(true);
	  queue.installPlugin(cjs.Sound);      
	  queue.on("complete", function(){ READY = true;          init(); });    
	  queue.on("error", function(e){ console.log(e); });    

	  queue.loadManifest([
              {id:"moonJPG", src:"moonOpt.jpg"},
              {id:"shadow", src:"shadow5.png"},
              {id:"sight", src:"sight.png"},
              {id:"sound", src:"DescenteInfinie.ogg"}       
	  ]);
	  
      })();
    </script>

    <style>
      body {
          font-family: arial;
          font-size:16px;
          color:#222;
          text-align:center;
          background-color:#000;
      }
      canvas { display:block; margin:0px auto;}
    </style>

  </head>
  <body>

    <canvas id="canvas1" width="1100" height="500" style="background-color:#000; width:100%;"></canvas>

  </body>
</html>

